<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>경찰 양성 v0.29</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1224; --card:#111827; --text:#e5e7eb;
    --accent:#60a5fa; --good:#34d399; --warn:#f59e0b; --danger:#ef4444;
    --gap:12px; --r:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(135deg,#0b1022,#0b1e35 60%,#0b1022);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:var(--gap);grid-template-columns: 1fr minmax(0,1.2fr) 1fr}
  header{grid-column:1 / -1;background:var(--panel);border:1px solid #1f2b47;border-radius:var(--r);padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
  .btn{border:1px solid #2b364f;background:#10192b;color:#dbeafe;padding:10px 12px;border-radius:10px;cursor:pointer;text-decoration:none;user-select:none}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.good{background:#0f2e2a;border-color:#24564c}
  .btn.warn{background:#2a240f;border-color:#5d4b15}
  .btn.dang{background:#2a0f12;border-color:#5d1521}
  .btn.block{display:block;width:100%}
  .card{background:var(--card);border:1px solid #2b364f;border-radius:var(--r);padding:12px}
  .col{display:flex;flex-direction:column;gap:var(--gap)}
  .title{margin:0 0 8px 0;font-size:18px}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:8px}
  .tag{padding:2px 8px;border-radius:999px;border:1px solid #2b364f;background:#0d1426;font-size:12px}
  .hpbar{height:10px;background:#0b1224;border:1px solid #1e293b;border-radius:999px;overflow:hidden}
  .hpbar>span{display:block;height:100%;background:linear-gradient(90deg,#22d3ee,#10b981);width:100%}
  .log{max-height:240px;overflow:auto;font-size:13px;line-height:1.5;background:#0c1326;border:1px dashed #253352;border-radius:10px;padding:10px}
  .hr{height:1px;background:#22304e;margin:8px 0}
  /* Tabs (Right column) */
  .tabs{display:flex;gap:6px;margin-bottom:8px}
  .tab{flex:1;text-align:center;padding:8px;border:1px solid #2b364f;border-radius:8px;background:#0e162b;cursor:pointer;font-size:14px}
  .tab.active{background:#162342}
  .pane{display:none}
  .pane.show{display:block}
  /* Dice animation */
  .diceWrap{display:flex;gap:8px;align-items:center}
  .die{width:42px;height:42px;border-radius:8px;background:#0b1224;border:1px solid #1f2b47;display:grid;place-items:center;font-weight:700}
  .die.roll{animation:roll .3s linear infinite}
  @keyframes roll{
    0%{transform:rotate(0) scale(1)}
    50%{transform:rotate(180deg) scale(1.05)}
    100%{transform:rotate(360deg) scale(1)}
  }
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b1224;border:1px solid #1f2b47;color:#dbeafe;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-3px)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <span class="tag">경찰 양성 — 전투 모드</span>
        <span style="opacity:.8">v0.29</span>
      </div>
      <div class="row">
        <a class="btn" href="./index.html">⬅️ 인덱스</a>
        <button class="btn warn" id="btnQuit">의원면직</button>
      </div>
    </header>

    <!-- LEFT: 신원/상태 -->
    <section class="col">
      <div class="card">
        <h3 class="title">신원 선택</h3>
        <div class="stack">
          <div class="row">
            <label class="tag"><input type="radio" name="org" value="경찰"> 경찰</label>
            <label class="tag"><input type="radio" name="org" value="해양경찰"> 해양경찰</label>
          </div>
          <div class="row">
            <label class="tag"><input type="radio" name="sex" value="남자"> 남자</label>
            <label class="tag"><input type="radio" name="sex" value="여자"> 여자</label>
          </div>
          <div class="row">
            <label class="tag"><input type="radio" name="rank0" value="의경"> 의경</label>
            <label class="tag"><input type="radio" name="rank0" value="순경"> 순경</label>
            <label class="tag"><input type="radio" name="rank0" value="경위"> 경위</label>
          </div>
          <input id="nameInput" class="btn block" placeholder="이름(선택)" />
          <button class="btn block" id="btnStart">시작</button>
        </div>
      </div>

      <div class="card" id="statusCard">
        <h3 class="title">상태</h3>
        <div class="stack">
          <div class="row">
            <span id="rankTxt" class="tag">—</span>
            <span id="orgTxt" class="tag">—</span>
            <span id="sexTxt" class="tag">—</span>
            <span id="yearTxt" class="tag">연차 0</span>
            <span id="cashTxt" class="tag">💰 0</span>
            <span id="kitTxt" class="tag">🧰 0</span>
          </div>
          <div class="row" style="justify-content:space-between">
            <div>❤️ 체력 <span id="hpLabel">50/50</span></div>
            <div id="weaponLabel" style="opacity:.8">무기: 없음</div>
          </div>
          <div class="hpbar"><span id="hpBar"></span></div>
        </div>
      </div>
    </section>

    <!-- CENTER: 전투(메인) -->
    <section class="col">
      <div class="card" id="battleCard">
        <h3 class="title">⚔️ 전투</h3>
        <div class="row">
          <span id="enemyName" class="tag">—</span>
          <span class="tag">HP <span id="enemyHP">—</span></span>
        </div>
        <div class="hr"></div>

        <div class="stack">
          <div class="diceWrap">
            <div class="die" id="d1">–</div>
            <div class="die" id="d2">–</div>
            <span>vs</span>
            <div class="die" id="e1">–</div>
            <div class="die" id="e2">–</div>
          </div>

          <div class="row" id="lastRow" style="opacity:.9;font-size:13px">
            <span id="lastMine">나: —</span>
            <span id="lastEnemy">적: —</span>
            <span id="lastResult">결과: —</span>
          </div>

          <div class="row" style="gap:8px">
            <button class="btn" id="btnRoll">🎲 굴리기</button>
            <button class="btn" id="btnBaton">🪄 삼단봉(1)</button>
            <button class="btn" id="btnMedUse">🩹 구급(턴 소모, +30)</button>
          </div>
        </div>
      </div>

      <div class="card" id="endingCard" style="display:none">
        <h3 class="title">## 엔딩</h3>
        <div id="endingText" class="stack"></div>
        <div class="hr"></div>
        <button class="btn block" id="btnReset">신원 선택으로</button>
      </div>
    </section>

    <!-- RIGHT: 탭(필요시에만 표시) -->
    <section class="col">
      <div class="card">
        <div class="tabs">
          <div class="tab" data-pane="pane-battle">전투</div>
          <div class="tab" data-pane="pane-after">애프터</div>
          <div class="tab" data-pane="pane-shop">상점</div>
          <div class="tab" data-pane="pane-log">로그</div>
        </div>

        <div id="pane-battle" class="pane show">
          <p class="title" style="font-size:16px;margin-bottom:4px">전투 도움말</p>
          <p style="opacity:.8;font-size:13px">2D6 동시 비교: 더 큰 쪽이 <b>(차이)</b>만큼 피해. 동률은 피해 없음.</p>
        </div>

        <div id="pane-after" class="pane">
          <h3 class="title">애프터</h3>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button class="btn" id="btnAfterOpen">✅ 제압 처리</button>
            <button class="btn" id="btnWash">🧼 씻고 출근(HP+10, 다음 사건)</button>
            <button class="btn" id="btnMedUse2">🩹 구급 사용(HP+30)</button>
            <button class="btn" id="btnPromo">🎖️ 승진 도전</button>
          </div>
          <p class="hr"></p>
          <p style="opacity:.8;font-size:13px">제압 처리 시: 연차 +0.33, 💰+3</p>
        </div>

        <div id="pane-shop" class="pane">
          <h3 class="title">상점(영구)</h3>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button class="btn" data-weapon="22LR" data-cost="10">22lr (10)</button>
            <button class="btn" data-weapon="9MM" data-cost="20">9mm (20)</button>
            <button class="btn" data-weapon="SHOTGUN" data-cost="35">엽총 (35)</button>
            <button class="btn" data-weapon="TAZER" data-cost="50">테이저 (50)</button>
          </div>
        </div>

        <div id="pane-log" class="pane">
          <h3 class="title">이력 & 로그</h3>
          <div class="log" id="logBox"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">알림</div>

<script>
(function(){
  // ====== 상태 ======
  const STATE = {
    started:false, ended:false, afterOpen:false, locking:false,
    name:"", org:"", sex:"", rank:"—", year:0, cash:0, kit:0,
    hp:50, hpMax:50, weapon:null,
    enemy:null, logs:[]
  };
  const RANKS = ["의경","순경","경장","경사","경위","경감","경정","치안총감"];
  const PROMO_REQ = {"의경":6,"순경":7,"경장":8,"경사":9,"경위":10,"경감":10,"경정":11};

  // ====== 도구 ======
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const r=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const log=t=>{STATE.logs.unshift("• "+t); $("#logBox").innerHTML=STATE.logs.join("<br>");};
  const toast=t=>{const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1400);};
  const setTab=name=>{
    $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.pane===name));
    $$(".pane").forEach(p=>p.classList.toggle("show", p.id===name));
  };
  const hpUI=()=>{ $("#hpLabel").textContent=`${STATE.hp}/${STATE.hpMax}`; $("#hpBar").style.width=`${(STATE.hp/STATE.hpMax)*100}%`; };

  // ====== 초기화 ======
  const resetEnemy=()=>{ STATE.enemy = { name: ["불량배","폭주자","절도범","난동자","해상통행위반자"][r(0,4)], hp: r(18,28) }; };
  const resetGame=()=>{
    Object.assign(STATE,{started:false,ended:false,afterOpen:false,locking:false,name:"",org:"",sex:"",rank:"—",year:0,cash:0,kit:0,hp:50,hpMax:50,weapon:null,logs:[]});
    resetEnemy(); renderAll();
  };

  // ====== 렌더 ======
  const renderAll=()=>{
    $("#rankTxt").textContent = STATE.rank;
    $("#orgTxt").textContent = STATE.org || "—";
    $("#sexTxt").textContent = STATE.sex || "—";
    $("#yearTxt").textContent = `연차 ${STATE.year}`;
    $("#cashTxt").textContent = `💰 ${STATE.cash}`;
    $("#kitTxt").textContent = `🧰 ${STATE.kit}`;
    $("#weaponLabel").textContent = `무기: ${STATE.weapon??"없음"}`;
    hpUI();

    $("#enemyName").textContent = STATE.enemy?.name ?? "—";
    $("#enemyHP").textContent = STATE.enemy? STATE.enemy.hp : "—";

    // 엔딩 카드 토글
    $("#battleCard").style.display = STATE.ended ? "none" : "block";
    $("#endingCard").style.display = STATE.ended ? "block" : "none";

    // 탭 자동 전환
    if(!STATE.started){ setTab("pane-battle"); }
    else if(STATE.afterOpen){ setTab("pane-after"); }
    else{ setTab("pane-battle"); }

    // 버튼 활성
    ["#btnRoll","#btnBaton","#btnMedUse"].forEach(id=>{
      $(id).disabled = !(STATE.started && !STATE.afterOpen && !STATE.ended) || STATE.locking;
    });
    $("#btnQuit").disabled = !STATE.started || STATE.ended;
  };

  // ====== 시작 ======
  $("#btnStart").addEventListener("click", ()=>{
    const pick = (name)=> {
      const list = $$(`input[name=${name}]`);
      const sel = list.find(x=>x.checked)?.value;
      return sel || list[r(0,list.length-1)].value;
    };
    STATE.org = pick("org"); STATE.sex = pick("sex"); STATE.rank = pick("rank0");
    STATE.name = $("#nameInput").value.trim() || ["홍길동","김민재","정세라","박하늘","이담"][r(0,4)];
    STATE.started=true; STATE.ended=false; STATE.afterOpen=false; STATE.year=0; STATE.cash=0; STATE.kit=0; STATE.hp=50; STATE.hpMax=50; STATE.weapon=null;
    resetEnemy();
    log(`시작: ${STATE.org} ${STATE.rank} ${STATE.name} (${STATE.sex})`);
    toast("게임 시작");
    renderAll();
  });

  $("#btnQuit").addEventListener("click", ()=>{
    if(!STATE.started || STATE.ended) return;
    endWith("의원면직","의원면직 처리되었습니다.");
  });

  $("#btnReset").addEventListener("click", resetGame);

  // ====== 전투: v0.21 감성(동시 2D6 비교) + 주사위 애니메이션 ======
  const playDice = async (mineDiceEls, enemyDiceEls, ms=300)=>{
    STATE.locking=true; renderAll();
    const t0 = performance.now();
    mineDiceEls.concat(enemyDiceEls).forEach(el=>el.classList.add("roll"));
    // 롤링 중 숫자 빠르게 갱신
    let raf; const tick = (now)=>{
      if(now - t0 < ms){
        mineDiceEls.forEach(el=>el.textContent = r(1,6));
        enemyDiceEls.forEach(el=>el.textContent = r(1,6));
        raf = requestAnimationFrame(tick);
      }
    };
    raf = requestAnimationFrame(tick);
    await new Promise(res=>setTimeout(res,ms));
    cancelAnimationFrame(raf);
    mineDiceEls.concat(enemyDiceEls).forEach(el=>el.classList.remove("roll"));
    // 결과 확정
    const m1=r(1,6), m2=r(1,6), e1=r(1,6), e2=r(1,6);
    mineDiceEls[0].textContent=m1; mineDiceEls[1].textContent=m2;
    enemyDiceEls[0].textContent=e1; enemyDiceEls[1].textContent=e2;
    return { my: m1+m2, en: e1+e2 };
  };

  const applyDamageCompare = (sumMy,sumEn)=>{
    $("#lastMine").textContent = `나: ${sumMy}`;
    $("#lastEnemy").textContent = `적: ${sumEn}`;
    if(sumMy===sumEn){
      $("#lastResult").textContent = `결과: 동률(피해 없음)`;
      return;
    }
    const diff = Math.abs(sumMy - sumEn);
    if(sumMy>sumEn){
      STATE.enemy.hp = clamp(STATE.enemy.hp - diff, 0, 999);
      $("#lastResult").textContent = `결과: 내가 ${diff} 피해`;
      if(STATE.enemy.hp<=0){ STATE.afterOpen=true; log(`제압 완료: ${STATE.enemy.name}`); }
    }else{
      STATE.hp = clamp(STATE.hp - diff, 0, STATE.hpMax);
      $("#lastResult").textContent = `결과: 내가 ${diff} 피해를 받음`;
      if(STATE.hp<=0){ endWith("순직","체력이 0이 되어 전투 불능."); }
    }
  };

  const d1=$("#d1"), d2=$("#d2"), e1=$("#e1"), e2=$("#e2");

  $("#btnRoll").addEventListener("click", async ()=>{
    if(!(STATE.started && !STATE.afterOpen && !STATE.ended) || STATE.locking) return;
    const {my,en} = await playDice([d1,d2],[e1,e2],300);
    applyDamageCompare(my,en);
    renderAll();
    STATE.locking=false; renderAll();
  });

  $("#btnBaton").addEventListener("click", ()=>{
    if(!(STATE.started && !STATE.afterOpen && !STATE.ended) || STATE.locking) return;
    STATE.enemy.hp = clamp(STATE.enemy.hp - 1, 0, 999);
    $("#lastMine").textContent = `나: 삼단봉(1)`;
    $("#lastEnemy").textContent = `적: 대기`;
    $("#lastResult").textContent = `결과: 적 HP -1`;
    if(STATE.enemy.hp<=0){ STATE.afterOpen=true; log(`제압 완료: ${STATE.enemy.name}`); }
    renderAll();
  });

  $("#btnMedUse").addEventListener("click", ()=>{
    if(!(STATE.started && !STATE.afterOpen && !STATE.ended)) return;
    if(STATE.kit<=0){ toast("구급함 없음"); return; }
    STATE.kit--; STATE.hp = clamp(STATE.hp+30,0,STATE.hpMax);
    $("#lastMine").textContent = `나: 구급(HP +30)`;
    $("#lastEnemy").textContent = `적: 기회 발생(반격 없음)`; // v0.21 감성: 내 턴 소비, 적 추가공격 없음
    $("#lastResult").textContent = `결과: 회복`;
    renderAll();
  });

  // ====== 애프터 ======
  $("#btnAfterOpen").addEventListener("click", ()=>{
    if(!STATE.started || STATE.ended) return;
    if(!STATE.afterOpen){ toast("제압 완료 상태에서 처리합니다."); return; }
    STATE.year = +(STATE.year + 0.33).toFixed(2);
    STATE.cash += 3;
    log(`애프터 처리: 연차 +0.33, 💰+3`);
    renderAll();
  });

  $("#btnWash").addEventListener("click", ()=>{
    if(!STATE.afterOpen) { toast("제압 처리 후 진행"); return; }
    STATE.hp = clamp(STATE.hp+10,0,STATE.hpMax);
    resetEnemy(); STATE.afterOpen=false;
    log("씻고 출근: HP +10, 다음 사건");
    renderAll();
  });

  $("#btnMedUse2").addEventListener("click", ()=>{
    if(!STATE.afterOpen){ toast("제압 처리 후 가능"); return; }
    if(STATE.kit<=0){ toast("구급함 없음"); return; }
    STATE.kit--; STATE.hp = clamp(STATE.hp+30,0,STATE.hpMax);
    toast("HP +30");
    renderAll();
  });

  // 승진
  $("#btnPromo").addEventListener("click", ()=>{
    if(!STATE.afterOpen){ toast("제압 처리 후 도전"); return; }
    const need = PROMO_REQ[STATE.rank] ?? 10;
    const d = r(1,6)+r(1,6);
    if(d>=need){
      const idx = Math.min(RANKS.indexOf(STATE.rank)+1,RANKS.length-1);
      const from = STATE.rank, to = RANKS[idx]; STATE.rank = to;
      log(`승진: ${from} → ${to} (주사위 ${d} / 요구 ${need}+)`);
      toast(`승진: ${to}`);
    }else{
      log(`승진 실패 (주사위 ${d} / 요구 ${need}+)`);
      toast("승진 실패");
    }
    renderAll();
  });

  // 상점
  $("#pane-shop").addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-weapon]");
    if(!btn) return;
    const w = btn.dataset.weapon, cost = +btn.dataset.cost;
    if(STATE.cash < cost){ toast("자금 부족"); return; }
    STATE.cash -= cost; STATE.weapon = w;
    log(`무기 구매: ${w} (-${cost})`);
    $("#weaponLabel").textContent = `무기: ${w}`;
    renderAll();
  });

  // 엔딩
  const endWith = (type,text)=>{
    STATE.ended=true;
    $("#endingText").innerHTML = `<div class="stack"><div class="title">${type}</div><div>${text}</div></div>`;
    log(`엔딩: ${type}`);
    renderAll();
  };

  // 탭 클릭
  $$(".tab").forEach(t=>t.addEventListener("click", ()=>{
    const name=t.dataset.pane;
    // 전투 중엔 전투 탭만 허용, 제압 후엔 애프터/상점/로그 허용
    if(STATE.started && !STATE.afterOpen && !STATE.ended && name!=="pane-battle"){ toast("전투 중"); return; }
    if(STATE.afterOpen && name==="pane-battle"){ toast("제압 처리 후 전투 복귀"); return; }
    setTab(name);
  }));

  // 시작 세팅
  resetEnemy(); renderAll();
})();
</script>
</body>
</html>
