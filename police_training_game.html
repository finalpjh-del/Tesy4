<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ê²½ì°° ì–‘ì„± v0.21.1-hotfix</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1224; --card:#111827; --text:#e5e7eb;
    --accent:#60a5fa; --good:#34d399; --warn:#f59e0b; --danger:#ef4444;
    --gap:12px; --r:14px; --touch:44px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(135deg,#0b1022,#0b1e35 60%,#0b1022);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{
    max-width:1100px;margin:0 auto;padding:16px;
    display:grid;gap:var(--gap);
    grid-template-columns: 1fr minmax(0,1.2fr) 1fr;
  }
  header{grid-column:1 / -1;background:var(--panel);border:1px solid #1f2b47;border-radius:var(--r);padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
  .btn{border:1px solid #2b364f;background:#10192b;color:#dbeafe;padding:10px 12px;border-radius:10px;cursor:pointer;text-decoration:none;user-select:none;min-height:var(--touch)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.good{background:#0f2e2a;border-color:#24564c}
  .btn.warn{background:#2a240f;border-color:#5d4b15}
  .btn.dang{background:#2a0f12;border-color:#5d1521}
  .btn.block{display:block;width:100%}
  .card{background:var(--card);border:1px solid #2b364f;border-radius:var(--r);padding:12px}
  .col{display:flex;flex-direction:column;gap:var(--gap)}
  .title{margin:0 0 8px 0;font-size:18px}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:8px}
  .tag{padding:4px 10px;border-radius:999px;border:1px solid #2b364f;background:#0d1426;font-size:12px}
  .hpbar{height:10px;background:#0b1224;border:1px solid #1e293b;border-radius:999px;overflow:hidden}
  .hpbar>span{display:block;height:100%;background:linear-gradient(90deg,#22d3ee,#10b981);width:100%}
  .log{max-height:240px;overflow:auto;font-size:13px;line-height:1.5;background:#0c1326;border:1px dashed #253352;border-radius:10px;padding:10px}
  .hr{height:1px;background:#22304e;margin:8px 0}
  details summary{cursor:pointer;list-style:none}
  details summary::-webkit-details-marker{display:none}
  details.summarylike{border:1px solid #2b364f;background:#0e162b;border-radius:10px;padding:10px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b1224;border:1px solid #1f2b47;color:#dbeafe;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-3px)}

  /* ---- ì£¼ì‚¬ìœ„(pips) ---- */
  .dice{display:flex;gap:10px;align-items:center}
  .die{width:52px;height:52px;border-radius:12px;background:#0b1224;border:1px solid #1f2b47;position:relative;display:grid;place-items:center;perspective:600px}
  .pips{width:70%;height:70%;position:relative}
  .pip{width:18%;height:18%;background:#e5e7eb;border-radius:50%;position:absolute;opacity:0}
  .p1{left:8%; top:8%} .p2{left:41%; top:8%} .p3{left:74%; top:8%}
  .p4{left:8%; top:41%} .p5{left:41%; top:41%} .p6{left:74%; top:41%}
  .p7{left:8%; top:74%} .p8{left:41%; top:74%} .p9{left:74%; top:74%}
  .spin{animation:spin .3s linear}
  @keyframes spin{
    0%{transform:rotate3d(1,1,0,0) scale(1)}
    50%{transform:rotate3d(1,1,0,180deg) scale(1.06)}
    100%{transform:rotate3d(1,1,0,360deg) scale(1)}
  }

  /* ëª¨ë°”ì¼ ì„¸ë¡œ ìµœì í™” */
  @media (max-width: 760px) {
    .wrap{grid-template-columns:1fr}
    header{position:sticky;top:0;z-index:2}
    .die{width:64px;height:64px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <span class="tag">ê²½ì°° ì–‘ì„± â€” ì „íˆ¬ ëª¨ë“œ</span>
        <span style="opacity:.75">v0.21.1-hotfix</span>
      </div>
      <div class="row">
        <a class="btn" href="./index.html" id="btnHome">â¬…ï¸ ë©”ì¸</a>
        <button class="btn warn" id="btnQuit">ì˜ì›ë©´ì§</button>
      </div>
    </header>

    <!-- LEFT -->
    <section class="col">
      <div class="card">
        <h3 class="title">ì‹ ì› ì„ íƒ</h3>
        <p style="opacity:.8;font-size:13px;margin:0">ì„ íƒí•˜ì§€ ì•Šì€ í•­ëª©ì€ ë¬´ì‘ìœ„ë¡œ ì •í•´ì§‘ë‹ˆë‹¤.</p>
        <div class="stack" style="margin-top:8px">
          <div class="row">
            <label class="tag"><input type="radio" name="org" value="ê²½ì°°"> ê²½ì°°</label>
            <label class="tag"><input type="radio" name="org" value="í•´ì–‘ê²½ì°°"> í•´ì–‘ê²½ì°°</label>
          </div>
          <div class="row">
            <label class="tag"><input type="radio" name="sex" value="ë‚¨ì"> ë‚¨ì</label>
            <label class="tag"><input type="radio" name="sex" value="ì—¬ì"> ì—¬ì</label>
          </div>
          <!-- ì˜ê²½ ì—†ìŒ: ìˆœê²½ / ê²½ìœ„ë§Œ -->
          <div class="row">
            <label class="tag"><input type="radio" name="rank0" value="ìˆœê²½"> ìˆœê²½</label>
            <label class="tag"><input type="radio" name="rank0" value="ê²½ìœ„"> ê²½ìœ„</label>
          </div>
          <input id="nameInput" class="btn block" placeholder="ì´ë¦„(ì„ íƒ)" />
          <button class="btn block" id="btnStart">ì‹œì‘</button>
        </div>
      </div>

      <div class="card" id="statusCard" aria-live="polite">
        <h3 class="title">ìƒíƒœ</h3>
        <div class="stack">
          <div class="row">
            <span id="rankTxt" class="tag">â€”</span>
            <span id="orgTxt" class="tag">â€”</span>
            <span id="sexTxt" class="tag">â€”</span>
            <span id="yearTxt" class="tag">ì—°ì°¨ 0</span>
            <span id="cashTxt" class="tag">ğŸ’° 0</span>
            <span id="kitTxt" class="tag">ğŸ§° 0</span>
          </div>
          <div class="row" style="justify-content:space-between">
            <div>â¤ï¸ ì²´ë ¥ <span id="hpLabel">50/50</span></div>
            <div id="weaponLabel" style="opacity:.8">ë¬´ê¸°: ì—†ìŒ</div>
          </div>
          <div class="hpbar"><span id="hpBar" style="width:100%"></span></div>
        </div>
      </div>
    </section>

    <!-- CENTER -->
    <section class="col">
      <div class="card" id="battleCard">
        <h3 class="title">âš”ï¸ ì „íˆ¬</h3>

        <div class="dice" style="margin:6px 0 2px">
          <div class="die" id="dMe"><div class="pips"></div></div>
          <span>vs</span>
          <div class="die" id="dEn"><div class="pips"></div></div>
        </div>

        <div class="row" id="lastRow" style="opacity:.9;font-size:13px;margin-top:6px">
          <span id="lastMine">ë‚˜: â€”</span>
          <span id="lastEnemy">ì : â€”</span>
          <span id="lastResult">ê²°ê³¼: â€”</span>
        </div>

        <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:6px">
          <button class="btn" id="btnRoll">ğŸ² êµ´ë¦¬ê¸°</button>
          <button class="btn" id="btnBaton">ğŸª„ ì‚¼ë‹¨ë´‰ (1)</button>
          <button class="btn" id="btnShoot">ğŸ”« ê²©ë°œ (ë¬´ê¸°)</button>
          <button class="btn" id="btnSwap">ğŸ” ë¬´ê¸°ë³€í™˜</button>
        </div>

        <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:6px">
          <button class="btn good" id="btnMedUse">â¤ï¸+30 (í„´ ì†Œìš”)</button>
          <button class="btn" id="btnAfterOpen" style="display:none">âœ… ì œì•• ì™„ë£Œ ì²˜ë¦¬</button>
        </div>
      </div>

      <div class="card" id="endingCard" style="display:none">
        <h3 class="title">## ì—”ë”© â€” <span id="endingType">â€”</span></h3>
        <div id="endingText" class="stack"></div>
        <div class="hr"></div>
        <button class="btn block" id="btnReset">ì‹ ì› ì„ íƒìœ¼ë¡œ</button>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="col">
      <div class="card">
        <h3 class="title">ì• í”„í„°</h3>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnWash" disabled>ğŸ§¼ ì”»ê³  ì¶œê·¼</button>
          <button class="btn" id="btnMedUse2" disabled>ğŸ©¹ ì‚¬ìš© (â¤ï¸+30)</button>
          <button class="btn" id="btnPromo" disabled>ğŸ–ï¸ ìŠ¹ì§„ë„ì „</button>
        </div>
        <p class="hr"></p>
        <p style="opacity:.8;font-size:13px">ì œì•• ì™„ë£Œ ìƒíƒœì—ì„œë§Œ í™œì„±í™”ë©ë‹ˆë‹¤. ì²˜ë¦¬ ì‹œ ì—°ì°¨ +0.33, ğŸ’°+3</p>
      </div>

      <div class="card">
        <h3 class="title">ë¬´ê¸° êµ¬ë§¤(ì˜êµ¬)</h3>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn" data-weapon="22LR" data-cost="10" disabled>22lr (10)</button>
          <button class="btn" data-weapon="9MM" data-cost="20" disabled>9mm (20)</button>
          <button class="btn" data-weapon="SHOTGUN" data-cost="35" disabled>ì—½ì´ (35)</button>
          <button class="btn" data-weapon="TAZER" data-cost="50" disabled>í…Œì´ì € (50)</button>
        </div>
        <p class="hr"></p>
        <p style="opacity:.8;font-size:13px">ì œì•• í›„ ì• í”„í„° ë‹¨ê³„ì—ì„œë§Œ ìƒì ì´ ì—´ë¦½ë‹ˆë‹¤.</p>
      </div>

      <div class="card">
        <details>
          <summary class="summarylike">ì´ë ¥ & ë¡œê·¸ ì—´ê¸°/ë‹«ê¸°</summary>
          <div class="log" id="logBox"></div>
        </details>
      </div>
    </section>
  </div>

  <!-- ì•Œë¦¼ ëª¨ë‹¬ -->
  <dialog id="alertDlg">
    <div style="padding:12px 14px;background:#0c162c;border-bottom:1px solid #1f2b47;font-weight:600">ì•Œë¦¼</div>
    <div style="padding:14px" id="alertMsg">â€”</div>
    <div style="padding:12px 14px;background:#0c162c;border-top:1px solid #1f2b47;display:flex;justify-content:flex-end">
      <button class="btn" onclick="closeAlert()">í™•ì¸</button>
    </div>
  </dialog>

  <div class="toast" id="toast">ì•Œë¦¼</div>

<script>
(function(){
  // ===== ìƒíƒœ =====
  const S = {
    started:false, ended:false, locking:false, afterOpen:false,
    name:"", org:"", sex:"", rank:"â€”", year:0, cash:0, kit:0,
    hp:50, hpMax:50, weapon:null,
    enemy:null, logs:[]
  };
  const RANKS = ["ìˆœê²½","ê²½ì¥","ê²½ì‚¬","ê²½ìœ„","ê²½ê°","ê²½ì •","ì¹˜ì•ˆì´ê°"];
  const PROMO_REQ = {"ìˆœê²½":7,"ê²½ì¥":8,"ê²½ì‚¬":9,"ê²½ìœ„":10,"ê²½ê°":10,"ê²½ì •":11};

  // ===== ë„êµ¬ =====
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const r=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const log=t=>{S.logs.unshift("â€¢ "+t); $("#logBox").innerHTML=S.logs.join("<br>");};
  const toast=t=>{const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1400);};
  const alertMsg=t=>{ $("#alertMsg").textContent=t; $("#alertDlg").showModal(); };
  window.closeAlert=()=>$("#alertDlg").close();

  // ===== ì£¼ì‚¬ìœ„(pips) ìœ í‹¸ =====
  function ensurePips(el){
    const box = el.querySelector('.pips');
    if(box.children.length) return;
    for(let i=1;i<=9;i++){
      const c=document.createElement('div'); c.className='pip p'+i; box.appendChild(c);
    }
  }
  const FACE = {1:[5],2:[1,9],3:[1,5,9],4:[1,3,7,9],5:[1,3,5,7,9],6:[1,3,4,6,7,9]};
  function setDie(el,val){
    el.querySelectorAll('.pip').forEach(p=>p.style.opacity=0);
    (FACE[val]||[]).forEach(i=>{ const dot=el.querySelector('.p'+i); if(dot) dot.style.opacity=1; });
  }
  const dMe=$("#dMe"), dEn=$("#dEn"); [dMe,dEn].forEach(ensurePips);

  async function rollOnce(el, ms=300){
    if(!el) return r(1,6);
    try{
      el.classList.add('spin');
      const frames = Math.max(3, Math.floor(ms/60));
      for(let i=0;i<frames;i++){ setDie(el, r(1,6)); await wait(60); }
      el.classList.remove('spin');
      const final = r(1,6); setDie(el, final);
      if(navigator.vibrate) navigator.vibrate(15);
      return final;
    }catch(e){ console.error(e); return r(1,6); }
  }
  const wait = n=>new Promise(res=>setTimeout(res,n));

  // ===== init / render =====
  const resetEnemy=()=>{ S.enemy={ name:["ë¶ˆëŸ‰ë°°","í­ì£¼ì","ì ˆë„ë²”","ë‚œë™ì","í•´ìƒí†µí–‰ìœ„ë°˜ì"][r(0,4)], hp:r(18,28) }; };
  const resetGame=()=>{
    Object.assign(S,{started:false,ended:false,locking:false,afterOpen:false,name:"",org:"",sex:"",rank:"â€”",year:0,cash:0,kit:0,hp:50,hpMax:50,weapon:null,logs:[]});
    resetEnemy(); renderAll();
  };
  const hpUI=()=>{ $("#hpLabel").textContent=`${S.hp}/${S.hpMax}`; $("#hpBar").style.width=`${(S.hp/S.hpMax)*100}%`; };

  const renderAll=()=>{
    $("#rankTxt").textContent=S.rank; $("#orgTxt").textContent=S.org||"â€”"; $("#sexTxt").textContent=S.sex||"â€”";
    $("#yearTxt").textContent=`ì—°ì°¨ ${S.year}`; $("#cashTxt").textContent=`ğŸ’° ${S.cash}`; $("#kitTxt").textContent=`ğŸ§° ${S.kit}`;
    $("#weaponLabel").textContent=`ë¬´ê¸°: ${S.weapon??"ì—†ìŒ"}`; hpUI();
    $("#enemyName").textContent=S.enemy?.name ?? "â€”"; $("#enemyHP").textContent=S.enemy? S.enemy.hp : "â€”";
    $("#battleCard").style.display = S.ended ? "none" : "block";
    $("#endingCard").style.display = S.ended ? "block" : "none";

    const inBattle = S.started && !S.afterOpen && !S.ended;
    ["#btnRoll","#btnBaton","#btnShoot","#btnSwap","#btnMedUse"].forEach(id=>{
      const el=$(id); if(el) el.disabled = !inBattle || S.locking;
    });
    ["#btnWash","#btnMedUse2","#btnPromo"].forEach(id=>{
      const el=$(id); if(el) el.disabled = !S.afterOpen || S.ended;
    });
    $$("[data-weapon]").forEach(b=>b.disabled = !S.afterOpen || S.ended);
    $("#btnAfterOpen").style.display = S.afterOpen ? "inline-block" : "none";
    $("#btnQuit").disabled = !S.started || S.ended;
  };

  function safe(fn){ try{ fn(); }catch(e){ console.error(e); } }

  // ===== ê³µí†µ =====
  async function lock(ms=300){
    S.locking=true; renderAll();
    await wait(ms);
    S.locking=false; renderAll();
  }
  function endWith(type,text){
    S.ended=true;
    $("#endingType").textContent=type;
    $("#endingText").innerHTML = `<div class="stack"><div>${text}</div></div>`;
    log(`ì—”ë”©: ${type}`); renderAll();
  }
  function takeDamage(n){
    S.hp = clamp(S.hp - n, 0, S.hpMax);
    if(S.hp<=0){ endWith("ìˆœì§","ì²´ë ¥ì´ 0 ì´í•˜ê°€ ë˜ì–´ ì „íˆ¬ ë¶ˆëŠ¥."); }
  }

  // ===== ì‹œì‘ =====
  $("#btnStart").addEventListener("click", ()=>{
    const pick=(name)=>{ const list=$$(`input[name=${name}]`); const sel=list.find(x=>x.checked)?.value; return sel || list[r(0,list.length-1)].value; };
    S.org=pick("org"); S.sex=pick("sex"); S.rank=pick("rank0");
    S.name=$("#nameInput").value.trim() || ["í™ê¸¸ë™","ê¹€ë¯¼ì¬","ì •ì„¸ë¼","ë°•í•˜ëŠ˜","ì´ë‹´"][r(0,4)];
    Object.assign(S,{started:true,ended:false,afterOpen:false,year:0,cash:0,kit:0,hp:50,hpMax:50,weapon:null});
    resetEnemy(); log(`ì‹œì‘: ${S.org} ${S.rank} ${S.name} (${S.sex})`);
    toast("ê²Œì„ ì‹œì‘"); renderAll();
  });

  $("#btnQuit").addEventListener("click", ()=>{ if(!S.started||S.ended) return; endWith("ì˜ì›ë©´ì§","ì˜ì›ë©´ì§ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."); });
  $("#btnReset").addEventListener("click", resetGame);

  // ===== ì „íˆ¬: 1D6 ê°„ë‹¨ ë£° (ìš”ì²­ ë°˜ì˜) =====
  $("#btnRoll").addEventListener("click", async ()=>{
    if(!(S.started && !S.afterOpen && !S.ended) || S.locking) return;
    S.locking=true; renderAll();
    try{
      const my = await rollOnce(dMe, 300);              // ë‚´ê°€ ì¤€ í”¼í•´ = my
      S.enemy.hp = clamp(S.enemy.hp - my, 0, 999);
      $("#lastMine").textContent = `ë‚˜: ğŸ² ${my} â†’ í”¼í•´ ${my}`;
      if(S.enemy.hp<=0){
        $("#lastEnemy").textContent = `ì : â€”`;
        $("#lastResult").textContent = `ê²°ê³¼: ì œì•• ì™„ë£Œ`;
        S.afterOpen=true; $("#btnAfterOpen").style.display="inline-block";
        log(`ì œì•• ì™„ë£Œ: ${S.enemy.name}`);
      }else{
        const en = await rollOnce(dEn, 240);            // ì  ë°˜ê²© = âŒˆen/2âŒ‰ (ìµœì†Œ1)
        const taken = Math.max(1, Math.ceil(en/2));
        $("#lastEnemy").textContent = `ì : ğŸ² ${en} â†’ ë°˜ê²© ${taken}`;
        $("#lastResult").textContent = `ê²°ê³¼: ë‚´ê°€ ${taken} í”¼í•´ë¥¼ ë°›ìŒ`;
        takeDamage(taken);
      }
    }catch(e){
      console.error(e); alertMsg("ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    }finally{
      S.locking=false; renderAll();
    }
  });

  $("#btnBaton").addEventListener("click", async ()=>{
    if(!(S.started && !S.afterOpen && !S.ended) || S.locking) return;
    await lock(200);
    S.enemy.hp = clamp(S.enemy.hp - 1, 0, 999);
    $("#lastMine").textContent = `ë‚˜: ì‚¼ë‹¨ë´‰(1)`;
    $("#lastEnemy").textContent = `ì : ëŒ€ê¸°`;
    $("#lastResult").textContent = `ê²°ê³¼: ì  HP -1`;
    if(S.enemy.hp<=0){ S.afterOpen=true; log(`ì œì•• ì™„ë£Œ: ${S.enemy.name}`); }
    renderAll();
  });

  $("#btnShoot").addEventListener("click", async ()=>{
    if(!(S.started && !S.afterOpen && !S.ended) || S.locking) return;
    await lock(220);
    if(!S.weapon){ alertMsg("ë¬´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ì œì•• í›„ ìƒì ì—ì„œ êµ¬ë§¤í•˜ì„¸ìš”."); return; }
    const rng = { "22LR":[2,5], "9MM":[3,7], "SHOTGUN":[4,9], "TAZER":[0,0] }[S.weapon] || [0,0];
    if(S.weapon==="TAZER"){
      const dealt = r(3,6);
      S.enemy.hp = clamp(S.enemy.hp - dealt, 0, 999);
      $("#lastMine").textContent=`í…Œì´ì €: í”¼í•´ ${dealt} (ì  ì´ë²ˆ í„´ ë¬´íš¨)`;
      $("#lastEnemy").textContent=`ì : ê°ì „`;
      if(S.enemy.hp<=0){ S.afterOpen=true; log(`ì œì•• ì™„ë£Œ: ${S.enemy.name}`); }
      renderAll(); return;
    }
    const dealt = r(rng[0], rng[1]);
    S.enemy.hp = clamp(S.enemy.hp - dealt, 0, 999);
    $("#lastMine").textContent=`${S.weapon}: í”¼í•´ ${dealt}`;
    if(S.enemy.hp<=0){ S.afterOpen=true; log(`ì œì•• ì™„ë£Œ: ${S.enemy.name}`); renderAll(); return; }
    // ì  ë°˜ê²©(1D6 â†’ âŒˆd/2âŒ‰)
    const en = r(1,6);
    const taken = Math.max(1, Math.ceil(en/2));
    $("#lastEnemy").textContent=`ì : ë°˜ê²© ğŸ² ${en} â†’ ${taken}`;
    $("#lastResult").textContent=`ê²°ê³¼: ë‚´ê°€ ${taken} í”¼í•´ë¥¼ ë°›ìŒ`;
    takeDamage(taken);
    renderAll();
  });

  $("#btnSwap").addEventListener("click", ()=>{
    if(!(S.started && !S.afterOpen && !S.ended)) return;
    const order=[null,"22LR","9MM","SHOTGUN","TAZER"];
    const i=(order.indexOf(S.weapon)+1)%order.length;
    S.weapon=order[i]; toast(`ë¬´ê¸°ë³€í™˜: ${S.weapon??"ì—†ìŒ"}`); renderAll();
  });

  // ì „íˆ¬ ì¤‘ êµ¬ê¸‰: ë‚´ í„´ ì†Œëª¨, ì  ê³µê²©ë§Œ í—ˆìš©
  $("#btnMedUse").addEventListener("click", async ()=>{
    if(!(S.started && !S.afterOpen && !S.ended) || S.locking) return;
    if(S.kit<=0){ alertMsg("êµ¬ê¸‰í•¨ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    await lock(220);
    S.kit--; S.hp=clamp(S.hp+30,0,S.hpMax);
    $("#lastMine").textContent=`ë‚˜: êµ¬ê¸‰ +30`;
    // ì  ë°˜ê²©(1D6 â†’ âŒˆd/2âŒ‰)
    const en = r(1,6);
    const taken = Math.max(1, Math.ceil(en/2));
    $("#lastEnemy").textContent=`ì : ë°˜ê²© ğŸ² ${en} â†’ ${taken}`;
    $("#lastResult").textContent=`ê²°ê³¼: ë‚´ê°€ ${taken} í”¼í•´ë¥¼ ë°›ìŒ`;
    takeDamage(taken);
    renderAll();
  });

  // ===== ì• í”„í„° =====
  $("#btnAfterOpen").addEventListener("click", ()=>{
    if(!S.afterOpen || S.ended) return;
    S.year = +(S.year + 0.33).toFixed(2);
    S.cash += 3;
    log(`ì• í”„í„° ì²˜ë¦¬: ì—°ì°¨ +0.33, ğŸ’°+3`);
    ["#btnWash","#btnMedUse2","#btnPromo"].forEach(id=>{ const el=$(id); if(el) el.disabled=false; });
    $$("[data-weapon]").forEach(b=>b.disabled=false);
    renderAll();
  });

  $("#btnWash").addEventListener("click", ()=>{
    if(!S.afterOpen) return;
    S.hp = clamp(S.hp+10,0,S.hpMax);
    resetEnemy(); S.afterOpen=false;
    ["#btnWash","#btnMedUse2","#btnPromo"].forEach(id=>{ const el=$(id); if(el) el.disabled=true; });
    $$("[data-weapon]").forEach(b=>b.disabled=true);
    log("ì”»ê³  ì¶œê·¼: HP +10, ë‹¤ìŒ ì‚¬ê±´");
    renderAll();
  });

  $("#btnMedUse2").addEventListener("click", ()=>{
    if(!S.afterOpen) return;
    if(S.kit<=0){ alertMsg("êµ¬ê¸‰í•¨ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    S.kit--; S.hp=clamp(S.hp+30,0,S.hpMax);
    toast("ì²´ë ¥ +30"); renderAll();
  });

  $("#btnPromo").addEventListener("click", ()=>{
    if(!S.afterOpen) return;
    const need = PROMO_REQ[S.rank] ?? 10;
    const d = r(1,6)+r(1,6);
    if(d>=need){
      const idx=Math.min(RANKS.indexOf(S.rank)+1,RANKS.length-1);
      const from=S.rank, to=RANKS[idx]; S.rank=to;
      log(`ìŠ¹ì§„: ${from} â†’ ${to} (ì£¼ì‚¬ìœ„ ${d} / ìš”êµ¬ ${need}+)`); toast(`ìŠ¹ì§„: ${to}`);
    }else{
      log(`ìŠ¹ì§„ ì‹¤íŒ¨ (ì£¼ì‚¬ìœ„ ${d} / ìš”êµ¬ ${need}+)`); toast("ìŠ¹ì§„ ì‹¤íŒ¨");
    }
    renderAll();
  });

  // ìƒì 
  document.addEventListener("click", (e)=>{
    const b = e.target.closest("button[data-weapon]");
    if(!b) return;
    if(!S.afterOpen || S.ended) return;
    const w=b.dataset.weapon, cost=+b.dataset.cost;
    if(S.cash<cost){ alertMsg("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
    S.cash-=cost; S.weapon=w; log(`ë¬´ê¸° êµ¬ë§¤: ${w} (-${cost})`); renderAll();
  });

  // ì‹œì‘
  resetEnemy(); renderAll();
})();
</script>
</body>
</html>
