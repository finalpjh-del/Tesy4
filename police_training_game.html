<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>경찰 양성 v0.30</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1224; --card:#111827; --text:#e5e7eb;
    --accent:#60a5fa; --good:#34d399; --warn:#f59e0b; --danger:#ef4444;
    --gap:12px; --r:14px; --touch:48px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(135deg,#0b1022,#0b1e35 60%,#0b1022);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{
    max-width:1100px;margin:0 auto;padding:16px;
    display:grid;gap:var(--gap);
    grid-template-columns: 1fr minmax(0,1.2fr) 1fr;
  }
  header{grid-column:1 / -1;background:var(--panel);border:1px solid #1f2b47;border-radius:var(--r);padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
  .btn{border:1px solid #2b364f;background:#10192b;color:#dbeafe;padding:10px 14px;border-radius:12px;cursor:pointer;text-decoration:none;user-select:none;min-height:var(--touch)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.good{background:#0f2e2a;border-color:#24564c}
  .btn.warn{background:#2a240f;border-color:#5d4b15}
  .btn.dang{background:#2a0f12;border-color:#5d1521}
  .btn.block{display:block;width:100%}
  .card{background:var(--card);border:1px solid #2b364f;border-radius:var(--r);padding:12px}
  .col{display:flex;flex-direction:column;gap:var(--gap)}
  .title{margin:0 0 8px 0;font-size:18px}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:8px}
  .tag{padding:4px 10px;border-radius:999px;border:1px solid #2b364f;background:#0d1426;font-size:12px}
  .hpbar{height:10px;background:#0b1224;border:1px solid #1e293b;border-radius:999px;overflow:hidden}
  .hpbar>span{display:block;height:100%;background:linear-gradient(90deg,#22d3ee,#10b981);width:100%}
  .log{max-height:240px;overflow:auto;font-size:13px;line-height:1.5;background:#0c1326;border:1px dashed #253352;border-radius:10px;padding:10px}
  .hr{height:1px;background:#22304e;margin:8px 0}

  /* Tabs (Right column, 필요시에만) */
  .tabs{display:flex;gap:6px;margin-bottom:8px}
  .tab{flex:1;text-align:center;padding:10px;border:1px solid #2b364f;border-radius:10px;background:#0e162b;cursor:pointer;font-size:14px;min-height:var(--touch);display:flex;align-items:center;justify-content:center}
  .tab.active{background:#162342}
  .pane{display:none}
  .pane.show{display:block}

  /* ===== 주사위: 실제 눈(pips)로 애니메이션 ===== */
  .diceWrap{display:flex;gap:10px;align-items:center}
  .die{width:56px;height:56px;border-radius:12px;background:#0b1224;border:1px solid #1f2b47;display:grid;place-items:center;position:relative;perspective:600px}
  .pips{width:70%;height:70%;position:relative}
  .pip{width:18%;height:18%;background:#e5e7eb;border-radius:50%;position:absolute;opacity:0}
  /* 3x3 그리드 좌표 */
  .p1{left:8%; top:8%} .p2{left:41%; top:8%} .p3{left:74%; top:8%}
  .p4{left:8%; top:41%} .p5{left:41%; top:41%} .p6{left:74%; top:41%}
  .p7{left:8%; top:74%} .p8{left:41%; top:74%} .p9{left:74%; top:74%}
  .die.spin{animation:spin .3s linear infinite}
  @keyframes spin{
    0%{transform:rotate3d(1,1,0,0deg) scale(1)}
    50%{transform:rotate3d(1,1,0,180deg) scale(1.06)}
    100%{transform:rotate3d(1,1,0,360deg) scale(1)}
  }

  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b1224;border:1px solid #1f2b47;color:#dbeafe;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-3px)}

  /* ===== 모바일 세로 최적화 ===== */
  @media (max-width: 740px) {
    .wrap{grid-template-columns:1fr}
    header{position:sticky;top:0;z-index:2}
    .col-left{order:1}
    .col-center{order:2}
    .col-right{order:3}
    .die{width:64px;height:64px} /* 세로에서 주사위 더 크게 */
    .btn{font-size:15px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <span class="tag">경찰 양성 — 전투 모드</span>
        <span style="opacity:.8">v0.30</span>
      </div>
      <div class="row">
        <a class="btn" href="./index.html">⬅️ 인덱스</a>
        <button class="btn warn" id="btnQuit">의원면직</button>
      </div>
    </header>

    <!-- LEFT -->
    <section class="col col-left">
      <div class="card">
        <h3 class="title">신원 선택</h3>
        <div class="stack">
          <div class="row">
            <label class="tag"><input type="radio" name="org" value="경찰"> 경찰</label>
            <label class="tag"><input type="radio" name="org" value="해양경찰"> 해양경찰</label>
          </div>
          <div class="row">
            <label class="tag"><input type="radio" name="sex" value="남자"> 남자</label>
            <label class="tag"><input type="radio" name="sex" value="여자"> 여자</label>
          </div>
          <!-- 의경 제거: 시작 계급은 순경/경위만 제공(원래대로) -->
          <div class="row">
            <label class="tag"><input type="radio" name="rank0" value="순경"> 순경</label>
            <label class="tag"><input type="radio" name="rank0" value="경위"> 경위</label>
          </div>
          <input id="nameInput" class="btn block" placeholder="이름(선택)" />
          <button class="btn block" id="btnStart">시작</button>
        </div>
      </div>

      <div class="card" id="statusCard">
        <h3 class="title">상태</h3>
        <div class="stack">
          <div class="row">
            <span id="rankTxt" class="tag">—</span>
            <span id="orgTxt" class="tag">—</span>
            <span id="sexTxt" class="tag">—</span>
            <span id="yearTxt" class="tag">연차 0</span>
            <span id="cashTxt" class="tag">💰 0</span>
            <span id="kitTxt" class="tag">🧰 0</span>
          </div>
          <div class="row" style="justify-content:space-between">
            <div>❤️ 체력 <span id="hpLabel">50/50</span></div>
            <div id="weaponLabel" style="opacity:.8">무기: 없음</div>
          </div>
          <div class="hpbar"><span id="hpBar"></span></div>
        </div>
      </div>
    </section>

    <!-- CENTER -->
    <section class="col col-center">
      <div class="card" id="battleCard">
        <h3 class="title">⚔️ 전투</h3>
        <div class="row">
          <span id="enemyName" class="tag">—</span>
          <span class="tag">HP <span id="enemyHP">—</span></span>
        </div>
        <div class="hr"></div>

        <div class="stack">
          <div class="diceWrap">
            <!-- 내 주사위 -->
            <div class="die" id="d1"><div class="pips"></div></div>
            <div class="die" id="d2"><div class="pips"></div></div>
            <span>vs</span>
            <!-- 적 주사위 -->
            <div class="die" id="e1"><div class="pips"></div></div>
            <div class="die" id="e2"><div class="pips"></div></div>
          </div>

          <div class="row" id="lastRow" style="opacity:.9;font-size:13px">
            <span id="lastMine">나: —</span>
            <span id="lastEnemy">적: —</span>
            <span id="lastResult">결과: —</span>
          </div>

          <div class="row" style="gap:8px">
            <button class="btn" id="btnRoll">🎲 굴리기</button>
            <button class="btn" id="btnBaton">🪄 삼단봉(1)</button>
            <button class="btn" id="btnMedUse">🩹 구급(턴 소모, +30)</button>
          </div>
        </div>
      </div>

      <div class="card" id="endingCard" style="display:none">
        <h3 class="title">## 엔딩</h3>
        <div id="endingText" class="stack"></div>
        <div class="hr"></div>
        <button class="btn block" id="btnReset">신원 선택으로</button>
      </div>
    </section>

    <!-- RIGHT (필요시 노출) -->
    <section class="col col-right">
      <div class="card">
        <div class="tabs">
          <div class="tab" data-pane="pane-battle">전투</div>
          <div class="tab" data-pane="pane-after">애프터</div>
          <div class="tab" data-pane="pane-shop">상점</div>
          <div class="tab" data-pane="pane-log">로그</div>
        </div>

        <div id="pane-battle" class="pane show">
          <p class="title" style="font-size:16px;margin-bottom:4px">전투 도움말</p>
          <p style="opacity:.8;font-size:13px">v0.21 규칙 기반: 내 2D6 합에서 <b>2</b>를 뺀 값(최소 1)을 적 HP에 피해로 적용. 적은 2D6의 절반(내림, 최소 1)을 반격 피해로 적용.</p>
        </div>

        <div id="pane-after" class="pane">
          <h3 class="title">애프터</h3>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button class="btn" id="btnAfterOpen">✅ 제압 처리</button>
            <button class="btn" id="btnWash">🧼 씻고 출근(HP+10, 다음 사건)</button>
            <button class="btn" id="btnMedUse2">🩹 구급 사용(HP+30)</button>
            <button class="btn" id="btnPromo">🎖️ 승진 도전</button>
          </div>
          <p class="hr"></p>
          <p style="opacity:.8;font-size:13px">제압 처리 시: 연차 +0.33, 💰+3</p>
        </div>

        <div id="pane-shop" class="pane">
          <h3 class="title">상점(영구)</h3>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button class="btn" data-weapon="22LR" data-cost="10">22lr (10)</button>
            <button class="btn" data-weapon="9MM" data-cost="20">9mm (20)</button>
            <button class="btn" data-weapon="SHOTGUN" data-cost="35">엽총 (35)</button>
            <button class="btn" data-weapon="TAZER" data-cost="50">테이저 (50)</button>
          </div>
        </div>

        <div id="pane-log" class="pane">
          <h3 class="title">이력 & 로그</h3>
          <div class="log" id="logBox"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">알림</div>

<script>
(function(){
  // ===== 전역 상태 =====
  const STATE = {
    started:false, ended:false, afterOpen:false, locking:false,
    name:"", org:"", sex:"", rank:"—", year:0, cash:0, kit:0,
    hp:50, hpMax:50, weapon:null,
    enemy:null, logs:[]
  };
  // 의경 제거 버전
  const RANKS = ["순경","경장","경사","경위","경감","경정","치안총감"];
  const PROMO_REQ = {"순경":7,"경장":8,"경사":9,"경위":10,"경감":10,"경정":11};

  // 전투 규칙 모드: v0.21 기반(요청 없을 때 기본값)
  const COMBAT_MODE = "v021";

  // ===== 도구 =====
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const r=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const log=t=>{STATE.logs.unshift("• "+t); $("#logBox").innerHTML=STATE.logs.join("<br>");};
  const toast=t=>{const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1400);};
  const setTab=name=>{
    $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.pane===name));
    $$(".pane").forEach(p=>p.classList.toggle("show", p.id===name));
  };
  const hpUI=()=>{ $("#hpLabel").textContent=`${STATE.hp}/${STATE.hpMax}`; $("#hpBar").style.width=`${(STATE.hp/STATE.hpMax)*100}%`; };

  // ===== 적/게임 초기화 =====
  const resetEnemy=()=>{ STATE.enemy = { name: ["불량배","폭주자","절도범","난동자","해상통행위반자"][r(0,4)], hp: r(18,28) }; };
  const resetGame=()=>{
    Object.assign(STATE,{started:false,ended:false,afterOpen:false,locking:false,name:"",org:"",sex:"",rank:"—",year:0,cash:0,kit:0,hp:50,hpMax:50,weapon:null,logs:[]});
    resetEnemy(); renderAll();
  };

  // ===== 렌더 =====
  const renderAll=()=>{
    $("#rankTxt").textContent = STATE.rank;
    $("#orgTxt").textContent = STATE.org || "—";
    $("#sexTxt").textContent = STATE.sex || "—";
    $("#yearTxt").textContent = `연차 ${STATE.year}`;
    $("#cashTxt").textContent = `💰 ${STATE.cash}`;
    $("#kitTxt").textContent = `🧰 ${STATE.kit}`;
    $("#weaponLabel").textContent = `무기: ${STATE.weapon??"없음"}`;
    hpUI();

    $("#enemyName").textContent = STATE.enemy?.name ?? "—";
    $("#enemyHP").textContent = STATE.enemy? STATE.enemy.hp : "—";

    $("#battleCard").style.display = STATE.ended ? "none" : "block";
    $("#endingCard").style.display = STATE.ended ? "block" : "none";

    if(!STATE.started){ setTab("pane-battle"); }
    else if(STATE.afterOpen){ setTab("pane-after"); }
    else{ setTab("pane-battle"); }

    ["#btnRoll","#btnBaton","#btnMedUse"].forEach(id=>{
      $(id).disabled = !(STATE.started && !STATE.afterOpen && !STATE.ended) || STATE.locking;
    });
    $("#btnQuit").disabled = !STATE.started || STATE.ended;
  };

  // ===== 시작 =====
  $("#btnStart").addEventListener("click", ()=>{
    const pick = (name)=> {
      const list = $$(`input[name=${name}]`);
      const sel = list.find(x=>x.checked)?.value;
      return sel || list[r(0,list.length-1)].value;
    };
    STATE.org = pick("org"); STATE.sex = pick("sex"); STATE.rank = pick("rank0");
    STATE.name = $("#nameInput").value.trim() || ["홍길동","김민재","정세라","박하늘","이담"][r(0,4)];
    STATE.started=true; STATE.ended=false; STATE.afterOpen=false;
    STATE.year=0; STATE.cash=0; STATE.kit=0; STATE.hp=50; STATE.hpMax=50; STATE.weapon=null;
    resetEnemy();
    log(`시작: ${STATE.org} ${STATE.rank} ${STATE.name} (${STATE.sex})`);
    toast("게임 시작");
    renderAll();
  });

  $("#btnQuit").addEventListener("click", ()=>{
    if(!STATE.started || STATE.ended) return;
    endWith("의원면직","의원면직 처리되었습니다.");
  });

  $("#btnReset").addEventListener("click", resetGame);

  // ===== 주사위: pips 기반 애니메이션 =====
  // pips 배치
  function ensurePips(el){
    const box = el.querySelector('.pips');
    if(box.children.length) return;
    for(let i=1;i<=9;i++){
      const c=document.createElement('div'); c.className='pip p'+i; box.appendChild(c);
    }
  }
  [$("#d1"),$("#d2"),$("#e1"),$("#e2")].forEach(ensurePips);

  // 눈 표시
  const FACE_MAP = {
    1:[5],
    2:[1,9],
    3:[1,5,9],
    4:[1,3,7,9],
    5:[1,3,5,7,9],
    6:[1,3,4,6,7,9]
  };
  function setDie(el, val){
    const p = el.querySelectorAll('.pip');
    p.forEach(x=>x.style.opacity=0);
    FACE_MAP[val].forEach(idx=>{
      el.querySelector('.p'+idx).style.opacity=1;
    });
  }

  // 애니메이션
  async function rollDice(mineEls, enemyEls, ms=300){
    STATE.locking=true; renderAll();
    mineEls.concat(enemyEls).forEach(el=>el.classList.add('spin'));

    const tickMs = 60;
    let t = 0;
    while(t < ms){
      mineEls.forEach(el=>setDie(el, r(1,6)));
      enemyEls.forEach(el=>setDie(el, r(1,6)));
      await wait(tickMs); t += tickMs;
    }
    mineEls.concat(enemyEls).forEach(el=>el.classList.remove('spin'));

    // 확정 값
    const m1=r(1,6), m2=r(1,6), e1=r(1,6), e2=r(1,6);
    setDie(mineEls[0],m1); setDie(mineEls[1],m2);
    setDie(enemyEls[0],e1); setDie(enemyEls[1],e2);

    // 모바일 햅틱
    if(navigator.vibrate){ navigator.vibrate(20); }

    return { my:m1+m2, en:e1+e2 };
  }
  const wait = (n)=>new Promise(res=>setTimeout(res,n));

  // ===== 전투 규칙(v0.21 기반) =====
  function applyDamage(sumMy,sumEn){
    $("#lastMine").textContent = `나: ${sumMy}`;
    $("#lastEnemy").textContent = `적: ${sumEn}`;

    if(COMBAT_MODE==="v021"){
      const dealt = Math.max(1, sumMy - 2);
      const taken = Math.max(1, Math.floor(sumEn/2));
      STATE.enemy.hp = clamp(STATE.enemy.hp - dealt, 0, 999);
      $("#lastResult").textContent = `결과: 내가 ${dealt} 피해 가함, ${taken} 피해 받음`;
      if(STATE.enemy.hp<=0){ STATE.afterOpen=true; log(`제압 완료: ${STATE.enemy.name}`); }
      else{
        STATE.hp = clamp(STATE.hp - taken, 0, STATE.hpMax);
        if(STATE.hp<=0) endWith("순직","체력이 0이 되어 전투 불능.");
      }
      return;
    }
  }

  const d1=$("#d1"), d2=$("#d2"), e1=$("#e1"), e2=$("#e2");

  $("#btnRoll").addEventListener("click", async ()=>{
    if(!(STATE.started && !STATE.afterOpen && !STATE.ended) || STATE.locking) return;
    const {my,en} = await rollDice([d1,d2],[e1,e2],300);
    applyDamage(my,en);
    renderAll();
    STATE.locking=false; renderAll();
  });

  $("#btnBaton").addEventListener("click", ()=>{
    if(!(STATE.started && !STATE.afterOpen && !STATE.ended) || STATE.locking) return;
    STATE.enemy.hp = clamp(STATE.enemy.hp - 1, 0, 999);
    $("#lastMine").textContent = `나: 삼단봉(1)`;
    $("#lastEnemy").textContent = `적: 대기`;
    $("#lastResult").textContent = `결과: 적 HP -1`;
    if(STATE.enemy.hp<=0){ STATE.afterOpen=true; log(`제압 완료: ${STATE.enemy.name}`); }
    renderAll();
  });

  $("#btnMedUse").addEventListener("click", ()=>{
    if(!(STATE.started && !STATE.afterOpen && !STATE.ended)) return;
    if(STATE.kit<=0){ toast("구급함 없음"); return; }
    STATE.kit--; STATE.hp = clamp(STATE.hp+30,0,STATE.hpMax);
    $("#lastMine").textContent = `나: 구급(HP +30)`;
    $("#lastEnemy").textContent = `적: 기회 발생(반격 없음)`;
    $("#lastResult").textContent = `결과: 회복`;
    renderAll();
  });

  // ===== 애프터 =====
  $("#btnAfterOpen").addEventListener("click", ()=>{
    if(!STATE.started || STATE.ended) return;
    if(!STATE.afterOpen){ toast("제압 완료 상태에서 처리"); return; }
    STATE.year = +(STATE.year + 0.33).toFixed(2);
    STATE.cash += 3;
    log(`애프터 처리: 연차 +0.33, 💰+3`);
    renderAll();
  });

  $("#btnWash").addEventListener("click", ()=>{
    if(!STATE.afterOpen) { toast("제압 처리 후 진행"); return; }
    STATE.hp = clamp(STATE.hp+10,0,STATE.hpMax);
    resetEnemy(); STATE.afterOpen=false;
    log("씻고 출근: HP +10, 다음 사건");
    renderAll();
  });

  $("#btnMedUse2").addEventListener("click", ()=>{
    if(!STATE.afterOpen){ toast("제압 처리 후 가능"); return; }
    if(STATE.kit<=0){ toast("구급함 없음"); return; }
    STATE.kit--; STATE.hp = clamp(STATE.hp+30,0,STATE.hpMax);
    toast("HP +30");
    renderAll();
  });

  // 승진
  $("#btnPromo").addEventListener("click", ()=>{
    if(!STATE.afterOpen){ toast("제압 처리 후 도전"); return; }
    const need = PROMO_REQ[STATE.rank] ?? 10;
    const d = r(1,6)+r(1,6);
    if(d>=need){
      const idx = Math.min(RANKS.indexOf(STATE.rank)+1,RANKS.length-1);
      const from = STATE.rank, to = RANKS[idx]; STATE.rank = to;
      log(`승진: ${from} → ${to} (주사위 ${d} / 요구 ${need}+)`);
      toast(`승진: ${to}`);
    }else{
      log(`승진 실패 (주사위 ${d} / 요구 ${need}+)`);
      toast("승진 실패");
    }
    renderAll();
  });

  // 상점
  $("#pane-shop").addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-weapon]");
    if(!btn) return;
    const w = btn.dataset.weapon, cost = +btn.dataset.cost;
    if(STATE.cash < cost){ toast("자금 부족"); return; }
    STATE.cash -= cost; STATE.weapon = w;
    log(`무기 구매: ${w} (-${cost})`);
    $("#weaponLabel").textContent = `무기: ${w}`;
    renderAll();
  });

  // 엔딩
  const endWith = (type,text)=>{
    STATE.ended=true;
    $("#endingText").innerHTML = `<div class="stack"><div class="title">${type}</div><div>${text}</div></div>`;
    log(`엔딩: ${type}`);
    renderAll();
  };

  // 탭 클릭: 전투 중엔 전투 탭만, 제압 후엔 애프터/상점/로그 허용
  $$(".tab").forEach(t=>t.addEventListener("click", ()=>{
    const name=t.dataset.pane;
    if(STATE.started && !STATE.afterOpen && !STATE.ended && name!=="pane-battle"){ toast("전투 중"); return; }
    if(STATE.afterOpen && name==="pane-battle"){ toast("제압 처리 후 전투 복귀"); return; }
    setTab(name);
  }));

  // 시작 세팅
  resetEnemy(); renderAll();
})();
</script>
</body>
</html>
