<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>경찰 양성 v0.21.1-hotfix</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1224; --card:#111827; --text:#e5e7eb;
    --accent:#60a5fa; --good:#34d399; --warn:#f59e0b; --danger:#ef4444;
    --gap:12px; --r:14px; --touch:44px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(135deg,#0b1022,#0b1e35 60%,#0b1022);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{
    max-width:1100px;margin:0 auto;padding:16px;
    display:grid;gap:var(--gap);
    grid-template-columns: 1fr minmax(0,1.2fr) 1fr;
  }
  header{grid-column:1 / -1;background:var(--panel);border:1px solid #1f2b47;border-radius:var(--r);padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
  .btn{border:1px solid #2b364f;background:#10192b;color:#dbeafe;padding:10px 12px;border-radius:10px;cursor:pointer;text-decoration:none;user-select:none;min-height:var(--touch)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.good{background:#0f2e2a;border-color:#24564c}
  .btn.warn{background:#2a240f;border-color:#5d4b15}
  .btn.dang{background:#2a0f12;border-color:#5d1521}
  .btn.block{display:block;width:100%}
  .card{background:var(--card);border:1px solid #2b364f;border-radius:var(--r);padding:12px}
  .col{display:flex;flex-direction:column;gap:var(--gap)}
  .title{margin:0 0 8px 0;font-size:18px}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:8px}
  .tag{padding:4px 10px;border-radius:999px;border:1px solid #2b364f;background:#0d1426;font-size:12px}
  .hpbar{height:10px;background:#0b1224;border:1px solid #1e293b;border-radius:999px;overflow:hidden}
  .hpbar>span{display:block;height:100%;background:linear-gradient(90deg,#22d3ee,#10b981);width:100%}
  .log{max-height:240px;overflow:auto;font-size:13px;line-height:1.5;background:#0c1326;border:1px dashed #253352;border-radius:10px;padding:10px}
  .hr{height:1px;background:#22304e;margin:8px 0}
  details summary{cursor:pointer;list-style:none}
  details summary::-webkit-details-marker{display:none}
  details.summarylike{border:1px solid #2b364f;background:#0e162b;border-radius:10px;padding:10px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b1224;border:1px solid #1f2b47;color:#dbeafe;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-3px)}

  /* ---- 주사위(pips) ---- */
  .dice{display:flex;gap:10px;align-items:center}
  .die{width:52px;height:52px;border-radius:12px;background:#0b1224;border:1px solid #1f2b47;position:relative;display:grid;place-items:center;perspective:600px}
  .pips{width:70%;height:70%;position:relative}
  .pip{width:18%;height:18%;background:#e5e7eb;border-radius:50%;position:absolute;opacity:0}
  .p1{left:8%; top:8%} .p2{left:41%; top:8%} .p3{left:74%; top:8%}
  .p4{left:8%; top:41%} .p5{left:41%; top:41%} .p6{left:74%; top:41%}
  .p7{left:8%; top:74%} .p8{left:41%; top:74%} .p9{left:74%; top:74%}
  .spin{animation:spin .3s linear}
  @keyframes spin{
    0%{transform:rotate3d(1,1,0,0) scale(1)}
    50%{transform:rotate3d(1,1,0,180deg) scale(1.06)}
    100%{transform:rotate3d(1,1,0,360deg) scale(1)}
  }

  /* 모바일 세로 최적화 */
  @media (max-width: 760px) {
    .wrap{grid-template-columns:1fr}
    header{position:sticky;top:0;z-index:2}
    .die{width:64px;height:64px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <span class="tag">경찰 양성 — 전투 모드</span>
        <span style="opacity:.75">v0.21.1-hotfix</span>
      </div>
      <div class="row">
        <a class="btn" href="./index.html" id="btnHome">⬅️ 메인</a>
        <button class="btn warn" id="btnQuit">의원면직</button>
      </div>
    </header>

    <!-- LEFT -->
    <section class="col">
      <div class="card">
        <h3 class="title">신원 선택</h3>
        <p style="opacity:.8;font-size:13px;margin:0">선택하지 않은 항목은 무작위로 정해집니다.</p>
        <div class="stack" style="margin-top:8px">
          <div class="row">
            <label class="tag"><input type="radio" name="org" value="경찰"> 경찰</label>
            <label class="tag"><input type="radio" name="org" value="해양경찰"> 해양경찰</label>
          </div>
          <div class="row">
            <label class="tag"><input type="radio" name="sex" value="남자"> 남자</label>
            <label class="tag"><input type="radio" name="sex" value="여자"> 여자</label>
          </div>
          <!-- 의경 없음: 순경 / 경위만 -->
          <div class="row">
            <label class="tag"><input type="radio" name="rank0" value="순경"> 순경</label>
            <label class="tag"><input type="radio" name="rank0" value="경위"> 경위</label>
          </div>
          <input id="nameInput" class="btn block" placeholder="이름(선택)" />
          <button class="btn block" id="btnStart">시작</button>
        </div>
      </div>

      <div class="card" id="statusCard" aria-live="polite">
        <h3 class="title">상태</h3>
        <div class="stack">
          <div class="row">
            <span id="rankTxt" class="tag">—</span>
            <span id="orgTxt" class="tag">—</span>
            <span id="sexTxt" class="tag">—</span>
            <span id="yearTxt" class="tag">연차 0</span>
            <span id="cashTxt" class="tag">💰 0</span>
            <span id="kitTxt" class="tag">🧰 0</span>
          </div>
          <div class="row" style="justify-content:space-between">
            <div>❤️ 체력 <span id="hpLabel">50/50</span></div>
            <div id="weaponLabel" style="opacity:.8">무기: 없음</div>
          </div>
          <div class="hpbar"><span id="hpBar" style="width:100%"></span></div>
        </div>
      </div>
    </section>

    <!-- CENTER -->
    <section class="col">
      <div class="card" id="battleCard">
        <h3 class="title">⚔️ 전투</h3>

        <div class="dice" style="margin:6px 0 2px">
          <div class="die" id="dMe"><div class="pips"></div></div>
          <span>vs</span>
          <div class="die" id="dEn"><div class="pips"></div></div>
        </div>

        <div class="row" id="lastRow" style="opacity:.9;font-size:13px;margin-top:6px">
          <span id="lastMine">나: —</span>
          <span id="lastEnemy">적: —</span>
          <span id="lastResult">결과: —</span>
        </div>

        <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:6px">
          <button class="btn" id="btnRoll">🎲 굴리기</button>
          <button class="btn" id="btnBaton">🪄 삼단봉 (1)</button>
          <button class="btn" id="btnShoot">🔫 격발 (무기)</button>
          <button class="btn" id="btnSwap">🔁 무기변환</button>
        </div>

        <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:6px">
          <button class="btn good" id="btnMedUse">❤️+30 (턴 소요)</button>
          <button class="btn" id="btnAfterOpen" style="display:none">✅ 제압 완료 처리</button>
        </div>
      </div>

      <div class="card" id="endingCard" style="display:none">
        <h3 class="title">## 엔딩 — <span id="endingType">—</span></h3>
        <div id="endingText" class="stack"></div>
        <div class="hr"></div>
        <button class="btn block" id="btnReset">신원 선택으로</button>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="col">
      <div class="card">
        <h3 class="title">애프터</h3>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnWash" disabled>🧼 씻고 출근</button>
          <button class="btn" id="btnMedUse2" disabled>🩹 사용 (❤️+30)</button>
          <button class="btn" id="btnPromo" disabled>🎖️ 승진도전</button>
        </div>
        <p class="hr"></p>
        <p style="opacity:.8;font-size:13px">제압 완료 상태에서만 활성화됩니다. 처리 시 연차 +0.33, 💰+3</p>
      </div>

      <div class="card">
        <h3 class="title">무기 구매(영구)</h3>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn" data-weapon="22LR" data-cost="10" disabled>22lr (10)</button>
          <button class="btn" data-weapon="9MM" data-cost="20" disabled>9mm (20)</button>
          <button class="btn" data-weapon="SHOTGUN" data-cost="35" disabled>엽총 (35)</button>
          <button class="btn" data-weapon="TAZER" data-cost="50" disabled>테이저 (50)</button>
        </div>
        <p class="hr"></p>
        <p style="opacity:.8;font-size:13px">제압 후 애프터 단계에서만 상점이 열립니다.</p>
      </div>

      <div class="card">
        <details>
          <summary class="summarylike">이력 & 로그 열기/닫기</summary>
          <div class="log" id="logBox"></div>
        </details>
      </div>
    </section>
  </div>

  <!-- 알림 모달 -->
  <dialog id="alertDlg">
    <div style="padding:12px 14px;background:#0c162c;border-bottom:1px solid #1f2b47;font-weight:600">알림</div>
    <div style="padding:14px" id="alertMsg">—</div>
    <div style="padding:12px 14px;background:#0c162c;border-top:1px solid #1f2b47;display:flex;justify-content:flex-end">
      <button class="btn" onclick="closeAlert()">확인</button>
    </div>
  </dialog>

  <div class="toast" id="toast">알림</div>

<script>
(function(){
  // ===== 상태 =====
  const S = {
    started:false, ended:false, locking:false, afterOpen:false,
    name:"", org:"", sex:"", rank:"—", year:0, cash:0, kit:0,
    hp:50, hpMax:50, weapon:null,
    enemy:null, logs:[]
  };
  const RANKS = ["순경","경장","경사","경위","경감","경정","치안총감"];
  const PROMO_REQ = {"순경":7,"경장":8,"경사":9,"경위":10,"경감":10,"경정":11};

  // ===== 도구 =====
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const r=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const log=t=>{S.logs.unshift("• "+t); $("#logBox").innerHTML=S.logs.join("<br>");};
  const toast=t=>{const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1400);};
  const alertMsg=t=>{ $("#alertMsg").textContent=t; $("#alertDlg").showModal(); };
  window.closeAlert=()=>$("#alertDlg").close();

  // ===== 주사위(pips) 유틸 =====
  function ensurePips(el){
    const box = el.querySelector('.pips');
    if(box.children.length) return;
    for(let i=1;i<=9;i++){
      const c=document.createElement('div'); c.className='pip p'+i; box.appendChild(c);
    }
  }
  const FACE = {1:[5],2:[1,9],3:[1,5,9],4:[1,3,7,9],5:[1,3,5,7,9],6:[1,3,4,6,7,9]};
  function setDie(el,val){
    el.querySelectorAll('.pip').forEach(p=>p.style.opacity=0);
    (FACE[val]||[]).forEach(i=>{ const dot=el.querySelector('.p'+i); if(dot) dot.style.opacity=1; });
  }
  const dMe=$("#dMe"), dEn=$("#dEn"); [dMe,dEn].forEach(ensurePips);

  async function rollOnce(el, ms=300){
    if(!el) return r(1,6);
    try{
      el.classList.add('spin');
      const frames = Math.max(3, Math.floor(ms/60));
      for(let i=0;i<frames;i++){ setDie(el, r(1,6)); await wait(60); }
      el.classList.remove('spin');
      const final = r(1,6); setDie(el, final);
      if(navigator.vibrate) navigator.vibrate(15);
      return final;
    }catch(e){ console.error(e); return r(1,6); }
  }
  const wait = n=>new Promise(res=>setTimeout(res,n));

  // ===== init / render =====
  const resetEnemy=()=>{ S.enemy={ name:["불량배","폭주자","절도범","난동자","해상통행위반자"][r(0,4)], hp:r(18,28) }; };
  const resetGame=()=>{
    Object.assign(S,{started:false,ended:false,locking:false,afterOpen:false,name:"",org:"",sex:"",rank:"—",year:0,cash:0,kit:0,hp:50,hpMax:50,weapon:null,logs:[]});
    resetEnemy(); renderAll();
  };
  const hpUI=()=>{ $("#hpLabel").textContent=`${S.hp}/${S.hpMax}`; $("#hpBar").style.width=`${(S.hp/S.hpMax)*100}%`; };

  const renderAll=()=>{
    $("#rankTxt").textContent=S.rank; $("#orgTxt").textContent=S.org||"—"; $("#sexTxt").textContent=S.sex||"—";
    $("#yearTxt").textContent=`연차 ${S.year}`; $("#cashTxt").textContent=`💰 ${S.cash}`; $("#kitTxt").textContent=`🧰 ${S.kit}`;
    $("#weaponLabel").textContent=`무기: ${S.weapon??"없음"}`; hpUI();
    $("#enemyName").textContent=S.enemy?.name ?? "—"; $("#enemyHP").textContent=S.enemy? S.enemy.hp : "—";
    $("#battleCard").style.display = S.ended ? "none" : "block";
    $("#endingCard").style.display = S.ended ? "block" : "none";

    const inBattle = S.started && !S.afterOpen && !S.ended;
    ["#btnRoll","#btnBaton","#btnShoot","#btnSwap","#btnMedUse"].forEach(id=>{
      const el=$(id); if(el) el.disabled = !inBattle || S.locking;
    });
    ["#btnWash","#btnMedUse2","#btnPromo"].forEach(id=>{
      const el=$(id); if(el) el.disabled = !S.afterOpen || S.ended;
    });
    $$("[data-weapon]").forEach(b=>b.disabled = !S.afterOpen || S.ended);
    $("#btnAfterOpen").style.display = S.afterOpen ? "inline-block" : "none";
    $("#btnQuit").disabled = !S.started || S.ended;
  };

  function safe(fn){ try{ fn(); }catch(e){ console.error(e); } }

  // ===== 공통 =====
  async function lock(ms=300){
    S.locking=true; renderAll();
    await wait(ms);
    S.locking=false; renderAll();
  }
  function endWith(type,text){
    S.ended=true;
    $("#endingType").textContent=type;
    $("#endingText").innerHTML = `<div class="stack"><div>${text}</div></div>`;
    log(`엔딩: ${type}`); renderAll();
  }
  function takeDamage(n){
    S.hp = clamp(S.hp - n, 0, S.hpMax);
    if(S.hp<=0){ endWith("순직","체력이 0 이하가 되어 전투 불능."); }
  }

  // ===== 시작 =====
  $("#btnStart").addEventListener("click", ()=>{
    const pick=(name)=>{ const list=$$(`input[name=${name}]`); const sel=list.find(x=>x.checked)?.value; return sel || list[r(0,list.length-1)].value; };
    S.org=pick("org"); S.sex=pick("sex"); S.rank=pick("rank0");
    S.name=$("#nameInput").value.trim() || ["홍길동","김민재","정세라","박하늘","이담"][r(0,4)];
    Object.assign(S,{started:true,ended:false,afterOpen:false,year:0,cash:0,kit:0,hp:50,hpMax:50,weapon:null});
    resetEnemy(); log(`시작: ${S.org} ${S.rank} ${S.name} (${S.sex})`);
    toast("게임 시작"); renderAll();
  });

  $("#btnQuit").addEventListener("click", ()=>{ if(!S.started||S.ended) return; endWith("의원면직","의원면직 처리되었습니다."); });
  $("#btnReset").addEventListener("click", resetGame);

  // ===== 전투: 1D6 간단 룰 (요청 반영) =====
  $("#btnRoll").addEventListener("click", async ()=>{
    if(!(S.started && !S.afterOpen && !S.ended) || S.locking) return;
    S.locking=true; renderAll();
    try{
      const my = await rollOnce(dMe, 300);              // 내가 준 피해 = my
      S.enemy.hp = clamp(S.enemy.hp - my, 0, 999);
      $("#lastMine").textContent = `나: 🎲 ${my} → 피해 ${my}`;
      if(S.enemy.hp<=0){
        $("#lastEnemy").textContent = `적: —`;
        $("#lastResult").textContent = `결과: 제압 완료`;
        S.afterOpen=true; $("#btnAfterOpen").style.display="inline-block";
        log(`제압 완료: ${S.enemy.name}`);
      }else{
        const en = await rollOnce(dEn, 240);            // 적 반격 = ⌈en/2⌉ (최소1)
        const taken = Math.max(1, Math.ceil(en/2));
        $("#lastEnemy").textContent = `적: 🎲 ${en} → 반격 ${taken}`;
        $("#lastResult").textContent = `결과: 내가 ${taken} 피해를 받음`;
        takeDamage(taken);
      }
    }catch(e){
      console.error(e); alertMsg("처리 중 예외가 발생했습니다. 다시 시도하세요.");
    }finally{
      S.locking=false; renderAll();
    }
  });

  $("#btnBaton").addEventListener("click", async ()=>{
    if(!(S.started && !S.afterOpen && !S.ended) || S.locking) return;
    await lock(200);
    S.enemy.hp = clamp(S.enemy.hp - 1, 0, 999);
    $("#lastMine").textContent = `나: 삼단봉(1)`;
    $("#lastEnemy").textContent = `적: 대기`;
    $("#lastResult").textContent = `결과: 적 HP -1`;
    if(S.enemy.hp<=0){ S.afterOpen=true; log(`제압 완료: ${S.enemy.name}`); }
    renderAll();
  });

  $("#btnShoot").addEventListener("click", async ()=>{
    if(!(S.started && !S.afterOpen && !S.ended) || S.locking) return;
    await lock(220);
    if(!S.weapon){ alertMsg("무기가 없습니다. 제압 후 상점에서 구매하세요."); return; }
    const rng = { "22LR":[2,5], "9MM":[3,7], "SHOTGUN":[4,9], "TAZER":[0,0] }[S.weapon] || [0,0];
    if(S.weapon==="TAZER"){
      const dealt = r(3,6);
      S.enemy.hp = clamp(S.enemy.hp - dealt, 0, 999);
      $("#lastMine").textContent=`테이저: 피해 ${dealt} (적 이번 턴 무효)`;
      $("#lastEnemy").textContent=`적: 감전`;
      if(S.enemy.hp<=0){ S.afterOpen=true; log(`제압 완료: ${S.enemy.name}`); }
      renderAll(); return;
    }
    const dealt = r(rng[0], rng[1]);
    S.enemy.hp = clamp(S.enemy.hp - dealt, 0, 999);
    $("#lastMine").textContent=`${S.weapon}: 피해 ${dealt}`;
    if(S.enemy.hp<=0){ S.afterOpen=true; log(`제압 완료: ${S.enemy.name}`); renderAll(); return; }
    // 적 반격(1D6 → ⌈d/2⌉)
    const en = r(1,6);
    const taken = Math.max(1, Math.ceil(en/2));
    $("#lastEnemy").textContent=`적: 반격 🎲 ${en} → ${taken}`;
    $("#lastResult").textContent=`결과: 내가 ${taken} 피해를 받음`;
    takeDamage(taken);
    renderAll();
  });

  $("#btnSwap").addEventListener("click", ()=>{
    if(!(S.started && !S.afterOpen && !S.ended)) return;
    const order=[null,"22LR","9MM","SHOTGUN","TAZER"];
    const i=(order.indexOf(S.weapon)+1)%order.length;
    S.weapon=order[i]; toast(`무기변환: ${S.weapon??"없음"}`); renderAll();
  });

  // 전투 중 구급: 내 턴 소모, 적 공격만 허용
  $("#btnMedUse").addEventListener("click", async ()=>{
    if(!(S.started && !S.afterOpen && !S.ended) || S.locking) return;
    if(S.kit<=0){ alertMsg("구급함이 없습니다."); return; }
    await lock(220);
    S.kit--; S.hp=clamp(S.hp+30,0,S.hpMax);
    $("#lastMine").textContent=`나: 구급 +30`;
    // 적 반격(1D6 → ⌈d/2⌉)
    const en = r(1,6);
    const taken = Math.max(1, Math.ceil(en/2));
    $("#lastEnemy").textContent=`적: 반격 🎲 ${en} → ${taken}`;
    $("#lastResult").textContent=`결과: 내가 ${taken} 피해를 받음`;
    takeDamage(taken);
    renderAll();
  });

  // ===== 애프터 =====
  $("#btnAfterOpen").addEventListener("click", ()=>{
    if(!S.afterOpen || S.ended) return;
    S.year = +(S.year + 0.33).toFixed(2);
    S.cash += 3;
    log(`애프터 처리: 연차 +0.33, 💰+3`);
    ["#btnWash","#btnMedUse2","#btnPromo"].forEach(id=>{ const el=$(id); if(el) el.disabled=false; });
    $$("[data-weapon]").forEach(b=>b.disabled=false);
    renderAll();
  });

  $("#btnWash").addEventListener("click", ()=>{
    if(!S.afterOpen) return;
    S.hp = clamp(S.hp+10,0,S.hpMax);
    resetEnemy(); S.afterOpen=false;
    ["#btnWash","#btnMedUse2","#btnPromo"].forEach(id=>{ const el=$(id); if(el) el.disabled=true; });
    $$("[data-weapon]").forEach(b=>b.disabled=true);
    log("씻고 출근: HP +10, 다음 사건");
    renderAll();
  });

  $("#btnMedUse2").addEventListener("click", ()=>{
    if(!S.afterOpen) return;
    if(S.kit<=0){ alertMsg("구급함이 없습니다."); return; }
    S.kit--; S.hp=clamp(S.hp+30,0,S.hpMax);
    toast("체력 +30"); renderAll();
  });

  $("#btnPromo").addEventListener("click", ()=>{
    if(!S.afterOpen) return;
    const need = PROMO_REQ[S.rank] ?? 10;
    const d = r(1,6)+r(1,6);
    if(d>=need){
      const idx=Math.min(RANKS.indexOf(S.rank)+1,RANKS.length-1);
      const from=S.rank, to=RANKS[idx]; S.rank=to;
      log(`승진: ${from} → ${to} (주사위 ${d} / 요구 ${need}+)`); toast(`승진: ${to}`);
    }else{
      log(`승진 실패 (주사위 ${d} / 요구 ${need}+)`); toast("승진 실패");
    }
    renderAll();
  });

  // 상점
  document.addEventListener("click", (e)=>{
    const b = e.target.closest("button[data-weapon]");
    if(!b) return;
    if(!S.afterOpen || S.ended) return;
    const w=b.dataset.weapon, cost=+b.dataset.cost;
    if(S.cash<cost){ alertMsg("자금이 부족합니다."); return; }
    S.cash-=cost; S.weapon=w; log(`무기 구매: ${w} (-${cost})`); renderAll();
  });

  // 시작
  resetEnemy(); renderAll();
})();
</script>
</body>
</html>
